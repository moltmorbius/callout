name: Guard Main Branch

on:
  push:
    branches: [main]

jobs:
  check-author:
    name: Block bot direct pushes
    runs-on: ubuntu-latest
    steps:
      - name: Check push origin
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check if this commit came from a merged pull request
          PR_COUNT=$(gh api "/repos/${{ github.repository }}/commits/${{ github.sha }}/pulls" \
            --jq '[.[] | select(.merged_at != null)] | length' 2>/dev/null || echo "0")

          if [ "$PR_COUNT" -gt "0" ]; then
            echo "✅ Push is from a merged PR. Allowed."
            exit 0
          fi

          # Not a PR merge — block bot direct pushes
          if [ "${{ github.actor }}" = "clawdmorbius" ]; then
            echo "❌ Direct push to main by clawdmorbius is not allowed."
            echo "Please create a PR and get CEO approval before merging."
            exit 1
          fi

          echo "✅ Push by ${{ github.actor }} allowed."

